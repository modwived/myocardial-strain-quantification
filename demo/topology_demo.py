#!/usr/bin/env python3
"""
OpenSage Topology Demo

Demonstrates both topology modes described in the OpenSage paper:

1. VERTICAL TOPOLOGY: Sequential task decomposition
   "vertical agent topology, which decomposes complex tasks into sequential
   sub-tasks to be completed by specialized sub-agents"

2. HORIZONTAL TOPOLOGY: Parallel agent ensemble
   "horizontal agent topology, where multiple sub-agents simultaneously
   execute the same task using distinct plans, with their results
   integrated through an agent ensemble mechanism"

The paper notes: "No existing ADKs support AI-created agent topologies,
meaning domain experts have to manually design the agent structure."

OpenSage changes this: the LLM itself decides and creates the topology.

Usage:
    python demo/topology_demo.py

Set ANTHROPIC_API_KEY to run with real Claude.
"""

import os
import sys
import time

sys.path.insert(0, os.path.dirname(os.path.dirname(os.path.abspath(__file__))))


def demo_topology_concepts():
    """Show topology concepts without API calls."""
    print("=" * 70)
    print("  OpenSage: Self-Generated Agent Topology Demo")
    print("=" * 70)

    print("""
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  OpenSage Topology: From Human-Centered to AI-Centered           â”‚
â”‚                                                                   â”‚
â”‚  Traditional ADKs (OpenHands, LangChain, Google ADK):           â”‚
â”‚  - Human designs agent topology manually                         â”‚
â”‚  - Static sub-agents with fixed roles                           â”‚
â”‚  - Sub-agent states discarded after execution                   â”‚
â”‚                                                                   â”‚
â”‚  OpenSage:                                                       â”‚
â”‚  - LLM creates topology dynamically at runtime                  â”‚
â”‚  - Agents spawn sub-agents as needed (vertical)                 â”‚
â”‚  - Multiple agents run in parallel (horizontal)                 â”‚
â”‚  - Sub-agent states preserved and shared                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
""")

    # ------------------------------------------------------------------ #
    # VERTICAL TOPOLOGY visualization                                     #
    # ------------------------------------------------------------------ #
    print("=" * 70)
    print("1. VERTICAL TOPOLOGY (Sequential Decomposition)")
    print("=" * 70)
    print("""
Task: "Fix security vulnerability CVE-2024-XXXX in authentication module"

SageAgent (parent) uses LLM to decompose:
â”‚
â”œâ”€â”€ Sub-agent: vulnerability_analyzer
â”‚   System: "You are a security analyst specializing in CVE analysis"
â”‚   Tools: [read_file, search_code, analyze_code]
â”‚   Task: Locate and understand the vulnerability
â”‚   â†“ passes findings â†’
â”‚
â”œâ”€â”€ Sub-agent: patch_developer
â”‚   System: "You are a security engineer who writes secure patches"
â”‚   Tools: [read_file, write_file, run_python, create_tool]
â”‚   Task: Develop a fix based on vulnerability analysis
â”‚   Context: â† receives findings from vulnerability_analyzer
â”‚   â†“ passes patch â†’
â”‚
â”œâ”€â”€ Sub-agent: test_engineer
â”‚   System: "You are a QA engineer specializing in security testing"
â”‚   Tools: [run_tests, run_python, search_code]
â”‚   Task: Write and run tests to verify the patch
â”‚   Context: â† receives patch from patch_developer
â”‚   â†“ passes results â†’
â”‚
â””â”€â”€ Sub-agent: report_writer
    System: "You write clear security incident reports"
    Tools: [read_file, write_file]
    Task: Document the fix for the security report
    Context: â† receives all findings + test results

Final: Parent synthesizes all sub-agent outputs into a complete solution

Key insight: Each sub-agent is created with tailored prompts, tools, and
context - NOT pre-defined by humans, but dynamically generated by the LLM.
""")

    # ------------------------------------------------------------------ #
    # HORIZONTAL TOPOLOGY visualization                                   #
    # ------------------------------------------------------------------ #
    print("=" * 70)
    print("2. HORIZONTAL TOPOLOGY (Parallel Ensemble)")
    print("=" * 70)
    print("""
Task: "Implement a high-performance sorting algorithm for large datasets"

SageAgent launches 3 parallel agents with different strategies:

           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚            Task (same for all)               â”‚
           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚                â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
         â”‚  Agent:       â”‚    â”‚  Agent:        â”‚    â”‚  Agent:        â”‚
         â”‚  systematic   â”‚    â”‚  heuristic     â”‚    â”‚  exhaustive    â”‚
         â”‚               â”‚    â”‚                â”‚    â”‚                â”‚
         â”‚ Strategy:     â”‚    â”‚ Strategy:      â”‚    â”‚ Strategy:      â”‚
         â”‚ - Analyze     â”‚    â”‚ - Use domain   â”‚    â”‚ - Try multiple â”‚
         â”‚   problem     â”‚    â”‚   knowledge    â”‚    â”‚   approaches   â”‚
         â”‚ - Form hyp.   â”‚    â”‚ - Quick path   â”‚    â”‚ - Verify all   â”‚
         â”‚ - Test steps  â”‚    â”‚ - Then valid.  â”‚    â”‚   edge cases   â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚                   â”‚                       â”‚
                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                     â”‚
                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                         â”‚   Integrator (LLM)     â”‚
                         â”‚ - Compare solutions    â”‚
                         â”‚ - Select best          â”‚
                         â”‚ - Synthesize insights  â”‚
                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                     â”‚
                            Final Best Solution

Key insight: Different strategies surface different aspects of the solution.
The ensemble is more robust than any single agent.
""")

    # ------------------------------------------------------------------ #
    # ABLATION study from the paper                                       #
    # ------------------------------------------------------------------ #
    print("=" * 70)
    print("3. Ablation Study Results (from paper)")
    print("=" * 70)
    print("""
The paper tests 3 ablation configurations:

  Config          â”‚ CyberGym  â”‚ Terminal-B â”‚ SWE-Pro
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€
  NoHorizontal    â”‚ -15%      â”‚ -8%        â”‚ -11%
  NoVertical      â”‚ -23%      â”‚ -12%       â”‚ -18%
  NoFeature       â”‚ -41%      â”‚ -31%       â”‚ -35%
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€
  Full OpenSage   â”‚ SOTA ğŸ¥‡   â”‚ SOTA ğŸ¥‡    â”‚ +best

Key findings:
  - Both topologies contribute independently
  - Vertical topology has larger impact (task decomposition crucial)
  - Horizontal ensemble especially useful for CyberGym (ambiguous tasks)
  - Full feature set (memory + tooling + topology) = best performance
""")


def run_live_topology_demo():
    """Run live topology demo with real API calls."""
    api_key = os.environ.get("ANTHROPIC_API_KEY")
    if not api_key:
        print("\nâš   ANTHROPIC_API_KEY not set.")
        return

    from opensage import OpenSage

    engine = OpenSage(api_key=api_key, verbose=True)

    # Write a simple coding challenge
    challenge_code = """
def merge_sorted_lists(list1, list2):
    '''Merge two sorted lists into one sorted list.
    Current implementation has a bug.'''
    result = []
    i, j = 0, 0
    while i < len(list1) and j < len(list2):
        if list1[i] < list2[j]:
            result.append(list1[i])
            i += 1
        else:
            result.append(list2[j])
            j += 1
    # Bug: missing remainder handling
    return result
"""
    engine.executor.write_file("merge_challenge.py", challenge_code)

    # Demo 1: Vertical topology
    print("\n" + "="*60)
    print("DEMO: Vertical Topology on coding challenge")
    print("="*60)

    start = time.time()
    result = engine.solve(
        f"Fix the merge_sorted_lists function in {engine.executor.work_dir}/merge_challenge.py "
        f"and verify with test cases for: [], [1], [1,3], [1,3,5] merged with [2,4,6]",
        topology="vertical",
    )
    elapsed = time.time() - start

    print(f"\nVertical result ({elapsed:.1f}s):")
    print(result[:500])

    engine.executor.cleanup()


if __name__ == "__main__":
    demo_topology_concepts()

    api_key = os.environ.get("ANTHROPIC_API_KEY")
    if api_key:
        run_live_topology_demo()
    else:
        print("\n[Set ANTHROPIC_API_KEY to run live topology demos]")
